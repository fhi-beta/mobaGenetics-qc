# External libraries
sys.path.append('../lib')  # in order to find our local packages
import mobaQcTools as mqc  # local moba package
from shutil import copyfile

# configfile: "configR3.yaml" # for running rotterdam3 tests
configfile: "config.yaml" 

# Ensure bash as shell
shell.executable("/bin/bash")

# Pipeline variables and setup
include: "variables.py"
include: "batch_details.py"
include: "setup.py"

# A file with rule properties and ordering
with open("rules.yaml", 'r') as stream:
    rule_info = yaml.safe_load(stream)

# Report (top level)
report: "report/qc.rst"

# rule all
rule all:
    input:
        module_3_good_markers = expand((tmpMod3/"{batch}/m3_output_good_markers").with_suffix(".txt"), batch=batches),
        sex_check = expand(str(tmpMod3/"{batch}/{role}/sexcheck_report_x.sexcheck"), role=ROLES, batch=batches),
        
        samples_lmm = expand(str(resultPath/"{batch}/{role}/m4_output_lmm_samples.yaml"), role=ROLES, batch=batches),
        unrelated_samples = expand(str(resultPath/"{batch}/{role}/m4_output_unrelated_samples.yaml"), role=ROLES, batch=batches),
        
        mendelian_errors = expand(str(tmpMod5)+"/{batch}/mendelian_errors"+'{ext}', ext=['.bed','.bim','.fam'], batch=batches),
        # mendelian_errors_chr = expand(str(tmpMod5)+"/{batch}/mendelian_errors-updated-chr{chromo}"+'{ext}', ext=['.bed','.bim','.fam'], chromo=chrom, batch=batches),
        rayner_report = expand(resultPath/"{batch}/rayner_report.rst", batch=batches),
        
        pedigree_report = expand((resultPath/"{batch}/pedigree_fu_detector_solver").with_suffix(".yaml"), batch=batches),
        
        # For now: this is needed to force the plots into the report. Fix later
        # Uncomment when creating in the report with plots
        pca = expand(str(resultPath) + "/{batch}/{role}/core_pca.png", role=ROLES, batch=batches),
        ibd = expand(str(resultPath/"{batch}/{role}/ibd_estimate.png"), role=ROLES, batch=batches),
        ibd_accum_exclusion = expand(str(resultPath/"{batch}/{role}/ibd_accum_exclusion.png"), role=ROLES, batch=batches)

        # remove this when m4 is done
	# final output:
        #expand(config['output_base'] + 'mod5-shaping-preparation/tmp/hrc-update-complete-{chr}' + '{ext}', ext=['.bed','.bim','.fam'], chr=chrom),
	# expand(config['output_base'] + '{role}/pca/final_pca_covars.txt', role=ROLES),
	# config['output_base'] + 'sample_flag_list.txt'


# Include modules
include: "mod1-data-conversion.snake"
include: "mod2-sample-pedigree.snake"
include: "mod3-good-markers.snake"
include: "mod4-samples-unrelated.snake"
include: "mod5-phasing-prep.snake"

# for small tests. 
rule test:
    output: touch("foo")
    log: "test.log"
    run:
        print(config["plinklocal"])
        #mqc.test_me()
        print(config["plinklocal"])

# This can be ued to check/log stuff (like available memory). Is run once. 
# onstart:
#     print("NOT Starting the baby")
#     print(rules.test.log)


